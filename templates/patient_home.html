{% extends "base.html" %} {% block content %}
<div class="container mt-4">
  <div class="row mb-4">
    <div class="col-md-8 mx-auto">
      <div class="card shadow-lg border-0">
        <div class="card-body text-center p-5">
          <h2 class="text-muted">Hello, {{ current_user.username }}</h2>

          {% if status == 'High' %}
          <div class="alert alert-danger mt-3">
            <h1 class="display-1">
              <i class="fa-solid fa-triangle-exclamation"></i>
            </h1>
            <h3>HIGH RISK DETECTED</h3>
            <p class="lead">{{ advice }}</p>
          </div>

          {% elif status == 'Warning' %}
          <div class="alert alert-warning mt-3">
            <h1 class="display-1 text-warning">
              <i class="fa-solid fa-notes-medical"></i>
            </h1>
            <h3 class="text-dark">Medical Attention Advised</h3>
            <p class="lead text-dark">{{ advice }}</p>
          </div>

          {% elif status == 'Stable' %}
          <div class="alert alert-success mt-3">
            <h1 class="display-1">
              <i class="fa-solid fa-heart-circle-check"></i>
            </h1>
            <h3>You are Stable</h3>
            <p class="lead">{{ advice }}</p>
          </div>

          {% else %}
          <div class="alert alert-secondary mt-3">
            <h3>No Data Logged Today</h3>
            <p>Please log your vitals below.</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8 mx-auto">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
            <i class="fa-solid fa-notes-medical"></i> Log My Daily Vitals
          </h5>
        </div>
        <div class="card-body">
          <form method="POST" action="/add_vitals">
            <div class="row">
              <div class="col-6 mb-3">
                <label>Temperature (Â°C)</label>
                <input
                  type="number"
                  step="0.1"
                  name="temperature"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-6 mb-3">
                <label>Heart Rate (bpm)</label>
                <input
                  type="number"
                  name="heart_rate"
                  class="form-control"
                  required
                />
              </div>
            </div>
            <div class="row">
              <div class="col-6 mb-3">
                <label>Resp. Rate</label>
                <input
                  type="number"
                  name="resp_rate"
                  class="form-control"
                  required
                />
              </div>
              <div class="col-6 mb-3">
                <label>WBC (If known)</label>
                <input
                  type="number"
                  name="wbc_count"
                  class="form-control"
                  value="8000"
                  required
                />
                <small class="text-muted"
                  >Default: 8000 (if no blood test)</small
                >
              </div>
            </div>
            <button type="submit" class="btn btn-primary w-100 btn-lg">
              Check My Status
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4 mb-5">
    <div class="col-md-8 mx-auto">
      <h5>My Recovery History</h5>
      <div class="list-group">
        {% for entry in entries %}
        <div
          class="list-group-item d-flex justify-content-between align-items-center"
        >
          <div>
            <small class="text-muted"
              >{{ entry.timestamp.strftime('%Y-%m-%d %H:%M') }}</small
            ><br />
            <strong>T:</strong> {{ entry.temp }} | <strong>HR:</strong> {{
            entry.hr }}
          </div>

          {% if entry.status == 'High' %}
          <span class="badge bg-danger rounded-pill">Critical</span>
          {% elif entry.status == 'Warning' %}
          <span class="badge bg-warning text-dark rounded-pill"
            >Check Vitals</span
          >
          {% else %}
          <span class="badge bg-success rounded-pill">Stable</span>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000">
  <button
    class="btn btn-primary rounded-circle shadow-lg p-3"
    type="button"
    data-bs-toggle="collapse"
    data-bs-target="#chatBox"
  >
    <i class="fa-solid fa-robot fa-2x"></i>
  </button>
</div>

<div
  class="collapse"
  id="chatBox"
  style="
    position: fixed;
    bottom: 90px;
    right: 20px;
    z-index: 1000;
    width: 350px;
  "
>
  <div class="card shadow-lg border-primary">
    <div
      class="card-header bg-primary text-white d-flex justify-content-between"
    >
      <strong><i class="fa-solid fa-user-doctor"></i> VitalBot AI</strong>
      <button
        type="button"
        class="btn-close btn-close-white"
        data-bs-toggle="collapse"
        data-bs-target="#chatBox"
      ></button>
    </div>
    <div
      class="card-body bg-light"
      id="chatHistory"
      style="height: 250px; overflow-y: auto"
    >
      <div class="text-muted text-center small mt-2">
        I am reading your latest vitals...<br />Ask me anything!
      </div>
    </div>
    <div class="card-footer">
      <div class="input-group">
        <input
          type="text"
          id="userQuestion"
          class="form-control"
          placeholder="Type here..."
        />
        <button class="btn btn-primary" onclick="sendMessage()">
          <i class="fa-solid fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  async function sendMessage() {
    let input = document.getElementById("userQuestion");
    let history = document.getElementById("chatHistory");
    let text = input.value;
    if (!text) return;

    // 1. Show User Message
    history.innerHTML += `<div class="text-end mb-2"><span class="badge bg-primary p-2 text-wrap text-start" style="max-width: 80%;">${text}</span></div>`;
    input.value = "";

    // 2. Show Loading
    let loadingId = "load_" + Date.now();
    history.innerHTML += `<div class="text-start mb-2" id="${loadingId}"><span class="badge bg-secondary p-2">Thinking...</span></div>`;
    history.scrollTop = history.scrollHeight;

    // 3. Send to Backend
    let response = await fetch("/chat_with_ai", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question: text }),
    });
    let data = await response.json();

    // 4. Show AI Response
    document.getElementById(loadingId).remove();
    history.innerHTML += `<div class="text-start mb-2"><span class="badge bg-dark p-2 text-wrap" style="max-width: 90%;">${data.response}</span></div>`;
    history.scrollTop = history.scrollHeight;
  }
</script>
{% endblock %}
